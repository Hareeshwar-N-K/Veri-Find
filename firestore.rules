rules_version = '2';

// VeriFind - Firebase Security Rules
// Trust-based Lost & Found Platform
// 
// SECURITY PRINCIPLES:
// 1. found_items are PRIVATE - only visible to creator and admins
// 2. lost_items are semi-public - basic info visible, ownershipHints hidden
// 3. matches require verification before full access
// 4. All sensitive actions are logged to audit_logs

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Get user document
    // Get user document - returns null if doesn't exist
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user document exists
    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && userExists() && getUserData().role == 'admin';
    }
    
    // Check if user is moderator or admin
    function isModerator() {
      return isAuthenticated() && userExists() && getUserData().role in ['admin', 'moderator'];
    }
    
    // Check if user is not suspended (new users without profile are allowed)
    function isNotSuspended() {
      return isAuthenticated() && (!userExists() || getUserData().get('isSuspended', false) != true);
    }
    
    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // Check if only allowed fields are being updated
    function onlyUpdating(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }
    
    // ============================================
    // 1️⃣ USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Anyone can read basic user profiles
      allow read: if isAuthenticated();
      
      // Users can create their own profile on first login
      allow create: if isOwner(userId) 
        && hasRequiredFields(['uid', 'email', 'displayName', 'role', 'createdAt'])
        && request.resource.data.role == 'user'  // Can't self-assign admin
        && request.resource.data.isSuspended == false;
      
      // Users can update their own profile (limited fields)
      allow update: if isOwner(userId) 
        && onlyUpdating(['displayName', 'photoURL', 'lastActiveAt', 'updatedAt', 'notificationsEnabled', 'emailNotificationsEnabled'])
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'reputationPoints', 'badges', 'isSuspended']);
      
      // Allow system to update reputation points (when matches are verified)
      allow update: if isAuthenticated()
        && onlyUpdating(['reputationPoints', 'updatedAt']);
      
      // Admins can update any user (including role, suspension)
      allow update: if isAdmin();
      
      // No one can delete users (soft delete via isSuspended)
      allow delete: if false;
    }
    
    // ============================================
    // 2️⃣ FOUND_ITEMS COLLECTION (PRIVATE VAULT)
    // ============================================
    match /found_items/{itemId} {
      // Finder, moderators, or any authenticated user (for matching) can read
      // Note: For true privacy, matching should be done server-side, but for free tier
      // we allow authenticated users to read found items for client-side matching
      allow read: if isAuthenticated();
      
      // ✅ Authenticated users can create found items
      allow create: if isAuthenticated() 
        && isNotSuspended()
        && hasRequiredFields(['finderId', 'category', 'title', 'description', 'locationFound', 'currentStorageLocation', 'status', 'createdAt'])
        && request.resource.data.finderId == request.auth.uid
        && request.resource.data.status == 'pending'
        && request.resource.data.isPrivate == true;
      
      // Finder can update their own item (limited fields)
      allow update: if isOwner(resource.data.finderId)
        && isNotSuspended()
        && onlyUpdating(['title', 'description', 'currentStorageLocation', 'images', 'updatedAt'])
        && request.resource.data.finderId == resource.data.finderId; // Can't change finder
      
      // Admins/Moderators can update status and other fields
      allow update: if isModerator();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // ============================================
    // 3️⃣ LOST_ITEMS COLLECTION (Semi-Public)
    // ============================================
    match /lost_items/{itemId} {
      // ✅ Authenticated users can read lost items (for browsing)
      // Note: ownershipHints should be filtered out in queries
      allow read: if isAuthenticated();
      
      // ✅ Authenticated users can create lost items
      allow create: if isAuthenticated()
        && isNotSuspended()
        && hasRequiredFields(['ownerId', 'category', 'title', 'description', 'locationLost', 'dateLost', 'status', 'createdAt'])
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.status == 'searching';
      
      // Owner can update their own item
      allow update: if isOwner(resource.data.ownerId)
        && isNotSuspended()
        && request.resource.data.ownerId == resource.data.ownerId; // Can't change owner
      
      // Admins/Moderators can update
      allow update: if isModerator();
      
      // Owner or admin can delete
      allow delete: if isOwner(resource.data.ownerId) || isAdmin();
    }
    
    // ============================================
    // 4️⃣ MATCHES COLLECTION (Intelligence Layer)
    // ============================================
    match /matches/{matchId} {
      // Only participants (owner/finder) and moderators can read
      allow read: if isAuthenticated()
        && (resource.data.ownerId == request.auth.uid 
            || resource.data.finderId == request.auth.uid 
            || isModerator());
      
      // Allow authenticated users to create matches (client-side matching for free tier)
      // Validate that the creator is either the owner or finder
      // Note: createdAt uses serverTimestamp() so we don't require it in hasRequiredFields
      allow create: if isAuthenticated()
        && isNotSuspended()
        && hasRequiredFields(['ownerId', 'finderId', 'lostItemId', 'foundItemId', 'status'])
        && (request.resource.data.ownerId == request.auth.uid || request.resource.data.finderId == request.auth.uid)
        && request.resource.data.status in ['pending_verification', 'pending'];
      
      // Owner can update to submit quiz answer and mark as recovered
      allow update: if isOwner(resource.data.ownerId)
        && isNotSuspended()
        && onlyUpdating(['ownerAnswer', 'verificationQuiz', 'status', 'recoveredAt', 'updatedAt']);
      
      // Finder can update limited fields
      allow update: if isOwner(resource.data.finderId)
        && isNotSuspended()
        && onlyUpdating(['finderNotes', 'status', 'updatedAt']);
      
      // Admins/Moderators can update status
      allow update: if isModerator();
      
      // Participants or admins can delete
      allow delete: if (isOwner(resource.data.ownerId) || isOwner(resource.data.finderId) || isAdmin());
    }
    
    // ============================================
    // 5️⃣ RECOVERY_LEDGER (Public Wall of Fame)
    // ============================================
    match /recovery_ledger/{entryId} {
      // ✅ Anyone authenticated can read (public success stories)
      allow read: if isAuthenticated();
      
      // Allow participants to create recovery entries (client-side for free tier)
      allow create: if isAuthenticated()
        && isNotSuspended()
        && hasRequiredFields(['matchId', 'ownerId', 'finderId', 'recoveredAt', 'itemCategory'])
        && (request.resource.data.ownerId == request.auth.uid || request.resource.data.finderId == request.auth.uid);
      
      // No one can update or delete recovery entries
      allow update, delete: if false;
    }
    
    // ============================================
    // 6️⃣ AUDIT_LOGS (Security Records)
    // ============================================
    match /audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // Only Cloud Functions can create audit logs
      allow create: if false; // Created via Admin SDK
      
      // No one can update or delete audit logs
      allow update, delete: if false;
    }
    
    // ============================================
    // 7️⃣ CHAT_CHANNELS (Post-Verification)
    // ============================================
    match /chat_channels/{channelId} {
      // Only participants can read
      allow read: if isAuthenticated()
        && request.auth.uid in resource.data.participants;
      
      // Participants can create channels after match is verified
      allow create: if isAuthenticated()
        && isNotSuspended()
        && hasRequiredFields(['participants', 'matchId', 'isActive', 'createdAt'])
        && request.auth.uid in request.resource.data.participants;
      
      // Participants can update lastMessageAt
      allow update: if isAuthenticated()
        && request.auth.uid in resource.data.participants
        && onlyUpdating(['lastMessageAt', 'lastMessage']);
      
      // Admin can close channels
      allow update: if isAdmin();
      
      allow delete: if false;
    }
    
    // Chat Messages subcollection
    match /chat_channels/{channelId}/messages/{messageId} {
      // Participants can read messages
      allow read: if isAuthenticated()
        && request.auth.uid in get(/databases/$(database)/documents/chat_channels/$(channelId)).data.participants;
      
      // Participants can send messages
      allow create: if isAuthenticated()
        && request.auth.uid in get(/databases/$(database)/documents/chat_channels/$(channelId)).data.participants
        && request.resource.data.senderId == request.auth.uid
        && get(/databases/$(database)/documents/chat_channels/$(channelId)).data.isActive == true;
      
      // No editing or deleting messages
      allow update, delete: if false;
    }
    
    // ============================================
    // 8️⃣ SYSTEM_SETTINGS (Platform Configuration)
    // ============================================
    match /systemSettings/{settingId} {
      // Anyone authenticated can read system settings
      allow read: if isAuthenticated();
      
      // Only admins can create/update system settings
      allow create, update: if isAdmin();
      
      // No one can delete system settings
      allow delete: if false;
    }
    
    // ============================================
    // 9️⃣ NOTIFICATIONS (User Notifications)
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // System can create notifications for users
      // Users can create notifications (for internal matching system)
      allow create: if isAuthenticated()
        && request.resource.data.userId != null
        && hasRequiredFields(['userId', 'type', 'message', 'isRead', 'createdAt']);
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && onlyUpdating(['isRead', 'updatedAt']);
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
      
      // Admins can do everything
      allow read, write: if isAdmin();
    }
    
    // ============================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
